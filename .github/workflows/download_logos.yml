name: Download & Convert Show Logos
on:
  workflow_dispatch:  # Only triggered manually or by other workflows
# ðŸ‘‡ REQUIRED FOR PUSHING
permissions:
  contents: write
  actions: write  # Required to trigger deploy workflow
jobs:
  download-logos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true   # ðŸ‘ˆ allows push using GITHUB_TOKEN
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pillow requests
      
      - name: Run logo download script
        run: |
          python3 download_logos.py \
            --schedules-dir schedules \
            --out-dir downloaded-images \
            --base-url "https://tv-programma.it/wp-content/uploads" \
            --workers 64
      
      - name: Commit changes
        id: commit_changes
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add schedules downloaded-images
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          git commit -m "Auto-update logos & JSONs"
          git push origin HEAD
          echo "changes=true" >> $GITHUB_OUTPUT
      
      - name: Trigger deploy to WordPress workflow
        if: always()  # Trigger deploy even if no logo changes
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy-to-wp.yml/dispatches \
            -d '{"ref":"main"}'
          echo "âœ“ Triggered deploy-to-wp.yml workflow"
